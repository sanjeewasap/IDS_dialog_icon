import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
/**
 * Wrapper for the jQuery panel control.
 *
 */
export class SohoContextualActionPanelRef {
    /**
     * The component displayed as the panel content.
     *
     * @param componentRef - reference to the component defining the panel panel content.
     */
    set component(componentRef) {
        // The component can also implement the guard interface, if it does
        // use it.
        this.componentRef = componentRef;
    }
    /**
     * The component displayed inside the panel's frame, if specified.  This may
     * be null if the component is built from an HTML fragment or a jQuery selector.
     */
    get componentPanel() {
        if (this.componentRef) {
            return this.componentRef.instance;
        }
        return null;
    }
    /**
     * The buttonset API for the CAP dialog.
     *
     * @returns the buttonset API for the CAP dialog, if initialized.
     */
    get buttonsetAPI() {
        return this.contextualactionpanel ? this.contextualactionpanel.buttonsetAPI : undefined;
    }
    /**
     * Sets the whole options block for this contextual action panel.
     *
     * @param options - the options to set.
     */
    options(options) {
        this._options = $.extend(true, this._options, options);
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings = this._options;
        }
        return this;
    }
    /**
     * Sets the whole options block for this contextual action panel.
     *
     * @param modalSettings - the options to set.
     */
    modalSettings(modalSettings) {
        this._options.modalSettings = $.extend(true, this._options.modalSettings, modalSettings);
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.modalSettings = this._options.modalSettings;
        }
        return this;
    }
    /**
     * Ability to add class(es) to the parent CAP element.
     *
     * @param cssClass - the class(es) value to add in CAP element.
     */
    cssClass(cssClass) {
        if (this.contextualactionpanel && this.open()) {
            this.ngZone.runOutsideAngular(() => {
                const cap = jQuery('div.contextual-action-panel.modal');
                cap.addClass(`${cssClass}`);
            });
        }
        else {
            this._options.modalSettings = $.extend(true, this._options.modalSettings, { cssClass: cssClass });
            if (this.contextualactionpanel) {
                this.contextualactionpanel.settings.modalSettings = this._options.modalSettings;
            }
        }
        return this;
    }
    /** Add extra attributes like id's to the component **/
    attributes(attributes) {
        this._options.attributes = $.extend(true, this._options.attributes, attributes);
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.attributes = this._options.attributes;
        }
        return this;
    }
    /**
     * Sets the title of the panel.
     *
     * @param title - the title of the panel.
     */
    title(title) {
        this._options.title = title;
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.title = title;
        }
        return this;
    }
    /**
     * Sets the buttons to use on the panel panel.
     *
     * @deprecated (use modalSettings)
     * @param buttons - list of buttons to display
     */
    buttons(buttons) {
        this._options.buttons = buttons;
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.buttons = buttons;
        }
        return this;
    }
    /**
     * Sets the 'id' that the panel control uses.
     *
     * @deprecated (use modalSettings)
     * @param id - the id.
     */
    id(id) {
        this._options.id = id;
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.id = id;
        }
        return this;
    }
    /**
     * Sets the 'id' that the panel control uses.
     *
     * @param initializeContent - Sets the ability to initialize content.
     */
    initializeContent(initializeContent) {
        this._options.initializeContent = initializeContent;
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.initializeContent = initializeContent;
        }
        return this;
    }
    /**
     * Sets the 'centerTitle' that the panel control uses.
     *
     * @deprecated (use modalSettings)
     * @param centerTitle - Aligns title to center
     */
    centerTitle(centerTitle) {
        this._options.centerTitle = centerTitle;
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.centerTitle = centerTitle;
        }
        return this;
    }
    /**
     * Sets the 'trigger' that the panel control uses.
     *
     * @deprecated (use modalSettings)
     * @param trigger - when to open the panel.
     */
    trigger(trigger) {
        this._options.trigger = trigger;
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.trigger = trigger;
        }
        return this;
    }
    /**
     * Sets the 'content' that the panel control uses.
     *
     * @param content - a selector or string representing the panel content.
     */
    content(content) {
        this._options.content = content;
        if (this.contextualactionpanel) {
            this.contextualactionpanel.settings.content = content;
        }
        return this;
    }
    /**
     * Applies a function to the instantiated component,
     * allowing the component to be modified, or initialised.
     *
     * The function is provided with a typed value for the
     * instance.
     *
     * @param component - the instantiated instance.
     * @return the panel ref for onward assignment.
     */
    apply(fn) {
        if (fn && this.componentRef?.instance) {
            fn(this.componentRef?.instance);
        }
        return this;
    }
    /**
     * panel result property.
     *
     * @param panelResult - the stored result of the panel.
     */
    set panelResult(panelResult) {
        this._panelResult = panelResult;
    }
    get panelResult() {
        return this._panelResult;
    }
    /**
     * Constructor.
     */
    constructor(appRef, componentFactoryResolver, injector, ngZone, settings, panelComponent) {
        this.appRef = appRef;
        this.injector = injector;
        this.ngZone = ngZone;
        /** Event fired when the panel is opened. */
        this.open$ = new Subject();
        /** Event fired when the panel is closed. */
        this.close$ = new Subject();
        /** Event fired before closing the panel */
        this.beforeClose$ = new Subject();
        /** Event fired after closing the panel. */
        this.afterClose$ = new Subject();
        /** Event fired after opening the panel panel. */
        this.afterOpen$ = new Subject();
        /** Handle resource tidy up of this class. */
        this.destroyed$ = new Subject();
        // -------------------------------------------
        // Default options block
        // -------------------------------------------
        /**
         * Cached options.
         */
        this._options = {
            content: undefined,
            initializeContent: true,
            title: 'Contextual Action Panel',
            modalSettings: {
                title: undefined,
                buttons: [],
                centerTitle: false,
                showCloseBtn: false,
                trigger: 'immediate',
                useFlexToolbar: false
            }
        };
        if (settings) {
            this.options(settings);
        }
        if (panelComponent) {
            this.componentRef = componentFactoryResolver
                .resolveComponentFactory(panelComponent)
                .create(this.injector);
            appRef.attachView(this.componentRef.hostView);
            this._options.content = jQuery(this.componentRef.location.nativeElement);
        }
    }
    /**
     * Opens the panel.
     *
     * @return the panel ref.
     */
    open() {
        if (this.contextualactionpanel) {
            // this.contextualactionpanel.open();
            return this;
        }
        if (!this.componentRef && !this._options.content) {
            throw Error('componentRef or content must be initialised.');
        }
        this.jQueryElement = this.ngZone.runOutsideAngular(() => {
            const element = jQuery('body');
            element.contextualactionpanel(this._options);
            this.contextualactionpanel = element.data('contextualactionpanel');
            return this.contextualactionpanel?.element;
        });
        // Add listeners to control events
        this.jQueryElement?.on('close.contextualactionpanel', ((event, isCancelled) => {
            this.onClose(event, isCancelled);
        }));
        this.jQueryElement?.on('open.contextualactionpanel', ((event) => {
            this.onOpen(event);
        }));
        this.contextualactionpanel.panel?.on('afterclose.contextualactionpanel', ((event) => {
            this.onAfterClose(event);
        }));
        this.contextualactionpanel.panel?.on('afteropen.contextualactionpanel', ((event) => {
            this.onAfterOpen(event);
        }));
        this.contextualactionpanel.panel?.on('beforeclose.contextualactionpanel', ((event) => {
            this.onBeforeClose(event);
        }));
        return this;
    }
    /**
     * Closes the panel, if open. The panel is not closed
     * fully until the 'afterClosed' event is fired.
     *
     * @param panelResult - optional result - passed back to the caller.
     * @param doForce - optional - forces the modal to close.
     */
    close(panelResult, doForce) {
        this.panelResult = panelResult;
        if (this.contextualactionpanel) {
            this.ngZone.runOutsideAngular(() => {
                this.contextualactionpanel?.close(doForce);
            });
        }
        return this;
    }
    // ------------------------------------------
    // Events
    // ------------------------------------------
    /**
     * Opened Event.
     *
     * This event is fired when the panel is being opened.
     *
     * @param eventFn - the function to invoke when the panel is to be opened.
     */
    opened(eventFn) {
        this.open$.pipe(takeUntil(this.destroyed$)).subscribe((f) => {
            eventFn(f, this);
        });
        return this;
    }
    /**
     * Opened Event.
     * This event is fired after the panel has been opened.
     *
     * @param eventFn - the function to invoke when the panel is to be opened.
     */
    afterOpen(eventFn) {
        this.afterOpen$.pipe(takeUntil(this.destroyed$)).subscribe((f) => {
            eventFn(f, this);
        });
        return this;
    }
    /**
     * Before Closed Event.
     * This event is fired before closing the panel.
     *
     * @param eventFn - the function to invoke when the panel before closing.
     */
    beforeClose(eventFn) {
        this.beforeClose$.pipe(takeUntil(this.destroyed$)).subscribe((f) => {
            eventFn(f, this);
        });
        return this;
    }
    /**
     * Closed Event.
     *
     * This event is fired when the panel is being closed.
     *
     * @param eventFn - the function to invoke when the panel is to be closed.
     */
    closed(eventFn) {
        this.close$.pipe(takeUntil(this.destroyed$)).subscribe((result) => {
            eventFn(result, this, this.componentPanel);
        });
        return this;
    }
    /**
     * After Closed Event.
     *
     * This event is fired, with the result of the panel, when the panel has been
     * closed and destroyed.
     *
     * @param eventFn - the function to invoke after the panel has been closed.
     */
    afterClose(eventFn) {
        this.afterClose$.pipe(takeUntil(this.destroyed$)).subscribe((result) => {
            if (!eventFn) {
                return;
            }
            eventFn(result, this, this.componentPanel);
        });
        return this;
    }
    // -------------------------------------------
    // Event Handlers
    // -------------------------------------------
    /**
     * Handles the 'open' event, fired just before
     * the focus is assigned to a panel.
     *
     * @param event - full event object.
     */
    onOpen(event) {
        this.open$.next(event);
    }
    /**
     * Handles the 'afterOpen' event, fired after the panel panel
     * has been opened.
     *
     * @param event - full event object.
     */
    onAfterOpen(event) {
        this.afterOpen$.next(event);
    }
    /**
     * Handles the close event.
     *
     * @param event - full event object.
     * @param isCancelled - is true if the cancel button was pressed; otherwise false.
     */
    onClose(_event, isCancelled) {
        this.close$.next(isCancelled);
    }
    /**
     * Handles the 'afterClose' event, fired when th panel
     * has been closed and tidy up is required.
     *
     * @param event - full event object.
     */
    onAfterClose(_event) {
        // Pass the panel result back.
        this.ngZone.run(() => {
            this.afterClose$.next(this.panelResult);
            this.afterClose$.complete();
        });
        if (this.jQueryElement) {
            this.jQueryElement.off('close.contextualactionpanel open.contextualactionpanel');
        }
        this.contextualactionpanel?.destroy();
        this.contextualactionpanel = null;
        this.ngZone.run(() => {
            if (this.componentRef) {
                this.appRef.detachView(this.componentRef.hostView);
                this.componentRef.destroy();
                this.componentRef = null;
            }
            this.destroyed$.next(_event);
            this.destroyed$.complete();
        });
    }
    /**
     * Handles the 'beforeclose' event.
     *
     * @param event - full event object.
     */
    onBeforeClose(event) {
        this.beforeClose$.next(event);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29oby1jb250ZXh0dWFsLWFjdGlvbi1wYW5lbC5yZWYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZHMtZW50ZXJwcmlzZS1uZy9zcmMvbGliL2NvbnRleHR1YWwtYWN0aW9uLXBhbmVsL3NvaG8tY29udGV4dHVhbC1hY3Rpb24tcGFuZWwucmVmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNDOzs7R0FHRztBQUNILE1BQU0sT0FBTyw0QkFBNEI7SUErQnZDOzs7O09BSUc7SUFDSCxJQUFJLFNBQVMsQ0FBQyxZQUE2QjtRQUN6QyxtRUFBbUU7UUFDbkUsVUFBVTtRQUNWLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0lBQ25DLENBQUM7SUFFRDs7O09BR0c7SUFDSCxJQUFXLGNBQWM7UUFDdkIsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3JCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7U0FDbkM7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsSUFBVyxZQUFZO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDMUYsQ0FBQztJQXVCRDs7OztPQUlHO0lBQ0gsT0FBTyxDQUFDLE9BQXlDO1FBQy9DLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUV2RCxJQUFJLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtZQUM5QixJQUFJLENBQUMscUJBQXFC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QUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50UmVmLCBBcHBsaWNhdGlvblJlZiwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBJbmplY3RvciwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBQYW5lbENvbXBvbmVudFR5cGUgfSBmcm9tICcuJztcbmltcG9ydCB7IHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuLyoqXG4gKiBXcmFwcGVyIGZvciB0aGUgalF1ZXJ5IHBhbmVsIGNvbnRyb2wuXG4gKlxuICovXG5leHBvcnQgY2xhc3MgU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB7XG4gIC8qKiBDb21wb25lbnQgLSBpZiB0aGUgY29udGVudCBpcyBkZXJpdmVkIGZyb20gYW4gZXhpc3RpbmcgY29tcG9uZW50LiAqL1xuICBwcml2YXRlIGNvbXBvbmVudFJlZj86IENvbXBvbmVudFJlZjxUPiB8IG51bGw7XG5cbiAgLyoqIFNlbGVjdG9yIHJlZmVyZW5jaW5nIHRoZSBwYW5lbC1wYW5lbCBhZnRlciBpdCBoYXMgYmVlbiBtb3ZlZCB0byB0aGUgcGFuZWwgY29udGFpbmVyLiAqL1xuICBwcml2YXRlIGpRdWVyeUVsZW1lbnQ/OiBKUXVlcnk7XG5cbiAgLyoqIFNvaG8gQ29udHJvbCBBcGkgKi9cbiAgcHJpdmF0ZSBjb250ZXh0dWFsYWN0aW9ucGFuZWw/OiBTb2hvQ29udGV4dHVhbEFjdGlvblBhbmVsU3RhdGljIHwgbnVsbDtcblxuICAvKiogVGhlIHJlc3VsdCBvZiB0aGUgcGFuZWwuICovXG4gIHByaXZhdGUgX3BhbmVsUmVzdWx0OiBhbnk7XG5cbiAgLyoqIEV2ZW50IGZpcmVkIHdoZW4gdGhlIHBhbmVsIGlzIG9wZW5lZC4gKi9cbiAgcHJpdmF0ZSBvcGVuJDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcblxuICAvKiogRXZlbnQgZmlyZWQgd2hlbiB0aGUgcGFuZWwgaXMgY2xvc2VkLiAqL1xuICBwcml2YXRlIGNsb3NlJDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcblxuICAvKiogRXZlbnQgZmlyZWQgYmVmb3JlIGNsb3NpbmcgdGhlIHBhbmVsICovXG4gIHByaXZhdGUgYmVmb3JlQ2xvc2UkOiBTdWJqZWN0PGFueT4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIC8qKiBFdmVudCBmaXJlZCBhZnRlciBjbG9zaW5nIHRoZSBwYW5lbC4gKi9cbiAgcHJpdmF0ZSBhZnRlckNsb3NlJDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcblxuICAvKiogRXZlbnQgZmlyZWQgYWZ0ZXIgb3BlbmluZyB0aGUgcGFuZWwgcGFuZWwuICovXG4gIHByaXZhdGUgYWZ0ZXJPcGVuJDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3QoKTtcblxuICAvKiogSGFuZGxlIHJlc291cmNlIHRpZHkgdXAgb2YgdGhpcyBjbGFzcy4gKi9cbiAgcHJpdmF0ZSBkZXN0cm95ZWQkID0gbmV3IFN1YmplY3QoKTtcblxuICAvKipcbiAgICogVGhlIGNvbXBvbmVudCBkaXNwbGF5ZWQgYXMgdGhlIHBhbmVsIGNvbnRlbnQuXG4gICAqXG4gICAqIEBwYXJhbSBjb21wb25lbnRSZWYgLSByZWZlcmVuY2UgdG8gdGhlIGNvbXBvbmVudCBkZWZpbmluZyB0aGUgcGFuZWwgcGFuZWwgY29udGVudC5cbiAgICovXG4gIHNldCBjb21wb25lbnQoY29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8VD4pIHtcbiAgICAvLyBUaGUgY29tcG9uZW50IGNhbiBhbHNvIGltcGxlbWVudCB0aGUgZ3VhcmQgaW50ZXJmYWNlLCBpZiBpdCBkb2VzXG4gICAgLy8gdXNlIGl0LlxuICAgIHRoaXMuY29tcG9uZW50UmVmID0gY29tcG9uZW50UmVmO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBjb21wb25lbnQgZGlzcGxheWVkIGluc2lkZSB0aGUgcGFuZWwncyBmcmFtZSwgaWYgc3BlY2lmaWVkLiAgVGhpcyBtYXlcbiAgICogYmUgbnVsbCBpZiB0aGUgY29tcG9uZW50IGlzIGJ1aWx0IGZyb20gYW4gSFRNTCBmcmFnbWVudCBvciBhIGpRdWVyeSBzZWxlY3Rvci5cbiAgICovXG4gIHB1YmxpYyBnZXQgY29tcG9uZW50UGFuZWwoKTogVCB8IG51bGwge1xuICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZikge1xuICAgICAgcmV0dXJuIHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgYnV0dG9uc2V0IEFQSSBmb3IgdGhlIENBUCBkaWFsb2cuXG4gICAqXG4gICAqIEByZXR1cm5zIHRoZSBidXR0b25zZXQgQVBJIGZvciB0aGUgQ0FQIGRpYWxvZywgaWYgaW5pdGlhbGl6ZWQuXG4gICAqL1xuICBwdWJsaWMgZ2V0IGJ1dHRvbnNldEFQSSgpOiBTb2hvQnV0dG9uc2V0U3RhdGljIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwgPyB0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbC5idXR0b25zZXRBUEkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIERlZmF1bHQgb3B0aW9ucyBibG9ja1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgLyoqXG4gICAqIENhY2hlZCBvcHRpb25zLlxuICAgKi9cbiAgcHJpdmF0ZSBfb3B0aW9uczogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbE9wdGlvbnMgPSB7XG4gICAgY29udGVudDogdW5kZWZpbmVkLFxuICAgIGluaXRpYWxpemVDb250ZW50OiB0cnVlLCAvLyBpbml0aWFsaXplIGNvbnRlbnQgYmVmb3JlIG9wZW5pbmdcbiAgICB0aXRsZTogJ0NvbnRleHR1YWwgQWN0aW9uIFBhbmVsJyxcbiAgICBtb2RhbFNldHRpbmdzOiB7XG4gICAgICB0aXRsZTogdW5kZWZpbmVkLFxuICAgICAgYnV0dG9uczogW10sXG4gICAgICBjZW50ZXJUaXRsZTogZmFsc2UsXG4gICAgICBzaG93Q2xvc2VCdG46IGZhbHNlLFxuICAgICAgdHJpZ2dlcjogJ2ltbWVkaWF0ZScsXG4gICAgICB1c2VGbGV4VG9vbGJhcjogZmFsc2VcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIHdob2xlIG9wdGlvbnMgYmxvY2sgZm9yIHRoaXMgY29udGV4dHVhbCBhY3Rpb24gcGFuZWwuXG4gICAqXG4gICAqIEBwYXJhbSBvcHRpb25zIC0gdGhlIG9wdGlvbnMgdG8gc2V0LlxuICAgKi9cbiAgb3B0aW9ucyhvcHRpb25zOiBTb2hvQ29udGV4dHVhbEFjdGlvblBhbmVsT3B0aW9ucyk6IFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxSZWY8VD4ge1xuICAgIHRoaXMuX29wdGlvbnMgPSAkLmV4dGVuZCh0cnVlLCB0aGlzLl9vcHRpb25zLCBvcHRpb25zKTtcblxuICAgIGlmICh0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbCkge1xuICAgICAgdGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwuc2V0dGluZ3MgPSB0aGlzLl9vcHRpb25zO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIHdob2xlIG9wdGlvbnMgYmxvY2sgZm9yIHRoaXMgY29udGV4dHVhbCBhY3Rpb24gcGFuZWwuXG4gICAqXG4gICAqIEBwYXJhbSBtb2RhbFNldHRpbmdzIC0gdGhlIG9wdGlvbnMgdG8gc2V0LlxuICAgKi9cbiAgbW9kYWxTZXR0aW5ncyhtb2RhbFNldHRpbmdzOiBTb2hvTW9kYWxPcHRpb25zKTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB7XG4gICAgdGhpcy5fb3B0aW9ucy5tb2RhbFNldHRpbmdzID0gJC5leHRlbmQodHJ1ZSwgdGhpcy5fb3B0aW9ucy5tb2RhbFNldHRpbmdzLCBtb2RhbFNldHRpbmdzKTtcblxuICAgIGlmICh0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbCkge1xuICAgICAgdGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwuc2V0dGluZ3MubW9kYWxTZXR0aW5ncyA9IHRoaXMuX29wdGlvbnMubW9kYWxTZXR0aW5ncztcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBBYmlsaXR5IHRvIGFkZCBjbGFzcyhlcykgdG8gdGhlIHBhcmVudCBDQVAgZWxlbWVudC5cbiAgICpcbiAgICogQHBhcmFtIGNzc0NsYXNzIC0gdGhlIGNsYXNzKGVzKSB2YWx1ZSB0byBhZGQgaW4gQ0FQIGVsZW1lbnQuXG4gICAqL1xuICBjc3NDbGFzcyhjc3NDbGFzczogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsICYmIHRoaXMub3BlbigpKSB7XG4gICAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgIGNvbnN0IGNhcCA9IGpRdWVyeSgnZGl2LmNvbnRleHR1YWwtYWN0aW9uLXBhbmVsLm1vZGFsJyk7XG4gICAgICAgIGNhcC5hZGRDbGFzcyhgJHtjc3NDbGFzc31gKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9vcHRpb25zLm1vZGFsU2V0dGluZ3MgPSAkLmV4dGVuZCh0cnVlLCB0aGlzLl9vcHRpb25zLm1vZGFsU2V0dGluZ3MsIHsgY3NzQ2xhc3M6IGNzc0NsYXNzIH0pO1xuICAgICAgaWYgKHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsKSB7XG4gICAgICAgIHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsLnNldHRpbmdzLm1vZGFsU2V0dGluZ3MgPSB0aGlzLl9vcHRpb25zLm1vZGFsU2V0dGluZ3M7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKiogQWRkIGV4dHJhIGF0dHJpYnV0ZXMgbGlrZSBpZCdzIHRvIHRoZSBjb21wb25lbnQgKiovXG4gIGF0dHJpYnV0ZXMoYXR0cmlidXRlczogQXJyYXk8T2JqZWN0PiB8IE9iamVjdCk6IFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxSZWY8VD4ge1xuICAgIHRoaXMuX29wdGlvbnMuYXR0cmlidXRlcyA9ICQuZXh0ZW5kKHRydWUsIHRoaXMuX29wdGlvbnMuYXR0cmlidXRlcywgYXR0cmlidXRlcyk7XG5cbiAgICBpZiAodGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwpIHtcbiAgICAgIHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsLnNldHRpbmdzLmF0dHJpYnV0ZXMgPSB0aGlzLl9vcHRpb25zLmF0dHJpYnV0ZXM7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogU2V0cyB0aGUgdGl0bGUgb2YgdGhlIHBhbmVsLlxuICAgKlxuICAgKiBAcGFyYW0gdGl0bGUgLSB0aGUgdGl0bGUgb2YgdGhlIHBhbmVsLlxuICAgKi9cbiAgdGl0bGUodGl0bGU6IHN0cmluZyk6IFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxSZWY8VD4ge1xuICAgIHRoaXMuX29wdGlvbnMudGl0bGUgPSB0aXRsZTtcbiAgICBpZiAodGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwpIHtcbiAgICAgIHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsLnNldHRpbmdzLnRpdGxlID0gdGl0bGU7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIGJ1dHRvbnMgdG8gdXNlIG9uIHRoZSBwYW5lbCBwYW5lbC5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgKHVzZSBtb2RhbFNldHRpbmdzKVxuICAgKiBAcGFyYW0gYnV0dG9ucyAtIGxpc3Qgb2YgYnV0dG9ucyB0byBkaXNwbGF5XG4gICAqL1xuICBidXR0b25zKGJ1dHRvbnM6IFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxCdXR0b25bXSk6IFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxSZWY8VD4ge1xuICAgIHRoaXMuX29wdGlvbnMuYnV0dG9ucyA9IGJ1dHRvbnM7XG4gICAgaWYgKHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsKSB7XG4gICAgICB0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbC5zZXR0aW5ncy5idXR0b25zID0gYnV0dG9ucztcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogU2V0cyB0aGUgJ2lkJyB0aGF0IHRoZSBwYW5lbCBjb250cm9sIHVzZXMuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkICh1c2UgbW9kYWxTZXR0aW5ncylcbiAgICogQHBhcmFtIGlkIC0gdGhlIGlkLlxuICAgKi9cbiAgaWQoaWQ6IHN0cmluZyk6IFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxSZWY8VD4ge1xuICAgIHRoaXMuX29wdGlvbnMuaWQgPSBpZDtcbiAgICBpZiAodGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwpIHtcbiAgICAgIHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsLnNldHRpbmdzLmlkID0gaWQ7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlICdpZCcgdGhhdCB0aGUgcGFuZWwgY29udHJvbCB1c2VzLlxuICAgKlxuICAgKiBAcGFyYW0gaW5pdGlhbGl6ZUNvbnRlbnQgLSBTZXRzIHRoZSBhYmlsaXR5IHRvIGluaXRpYWxpemUgY29udGVudC5cbiAgICovXG4gIGluaXRpYWxpemVDb250ZW50KGluaXRpYWxpemVDb250ZW50OiBib29sZWFuKTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB7XG4gICAgdGhpcy5fb3B0aW9ucy5pbml0aWFsaXplQ29udGVudCA9IGluaXRpYWxpemVDb250ZW50O1xuICAgIGlmICh0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbCkge1xuICAgICAgdGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwuc2V0dGluZ3MuaW5pdGlhbGl6ZUNvbnRlbnQgPSBpbml0aWFsaXplQ29udGVudDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogU2V0cyB0aGUgJ2NlbnRlclRpdGxlJyB0aGF0IHRoZSBwYW5lbCBjb250cm9sIHVzZXMuXG4gICAqXG4gICAqIEBkZXByZWNhdGVkICh1c2UgbW9kYWxTZXR0aW5ncylcbiAgICogQHBhcmFtIGNlbnRlclRpdGxlIC0gQWxpZ25zIHRpdGxlIHRvIGNlbnRlclxuICAgKi9cbiAgY2VudGVyVGl0bGUoY2VudGVyVGl0bGU6IGJvb2xlYW4pOiBTb2hvQ29udGV4dHVhbEFjdGlvblBhbmVsUmVmPFQ+IHtcbiAgICB0aGlzLl9vcHRpb25zLmNlbnRlclRpdGxlID0gY2VudGVyVGl0bGU7XG4gICAgaWYgKHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsKSB7XG4gICAgICB0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbC5zZXR0aW5ncy5jZW50ZXJUaXRsZSA9IGNlbnRlclRpdGxlO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSAndHJpZ2dlcicgdGhhdCB0aGUgcGFuZWwgY29udHJvbCB1c2VzLlxuICAgKlxuICAgKiBAZGVwcmVjYXRlZCAodXNlIG1vZGFsU2V0dGluZ3MpXG4gICAqIEBwYXJhbSB0cmlnZ2VyIC0gd2hlbiB0byBvcGVuIHRoZSBwYW5lbC5cbiAgICovXG4gIHRyaWdnZXIodHJpZ2dlcjogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFRyaWdnZXJUeXBlKTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB7XG4gICAgdGhpcy5fb3B0aW9ucy50cmlnZ2VyID0gdHJpZ2dlcjtcbiAgICBpZiAodGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwpIHtcbiAgICAgIHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsLnNldHRpbmdzLnRyaWdnZXIgPSB0cmlnZ2VyO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSAnY29udGVudCcgdGhhdCB0aGUgcGFuZWwgY29udHJvbCB1c2VzLlxuICAgKlxuICAgKiBAcGFyYW0gY29udGVudCAtIGEgc2VsZWN0b3Igb3Igc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgcGFuZWwgY29udGVudC5cbiAgICovXG4gIGNvbnRlbnQoY29udGVudDogSlF1ZXJ5IHwgc3RyaW5nKTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB7XG4gICAgdGhpcy5fb3B0aW9ucy5jb250ZW50ID0gY29udGVudDtcbiAgICBpZiAodGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWwpIHtcbiAgICAgIHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsLnNldHRpbmdzLmNvbnRlbnQgPSBjb250ZW50O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBsaWVzIGEgZnVuY3Rpb24gdG8gdGhlIGluc3RhbnRpYXRlZCBjb21wb25lbnQsXG4gICAqIGFsbG93aW5nIHRoZSBjb21wb25lbnQgdG8gYmUgbW9kaWZpZWQsIG9yIGluaXRpYWxpc2VkLlxuICAgKlxuICAgKiBUaGUgZnVuY3Rpb24gaXMgcHJvdmlkZWQgd2l0aCBhIHR5cGVkIHZhbHVlIGZvciB0aGVcbiAgICogaW5zdGFuY2UuXG4gICAqXG4gICAqIEBwYXJhbSBjb21wb25lbnQgLSB0aGUgaW5zdGFudGlhdGVkIGluc3RhbmNlLlxuICAgKiBAcmV0dXJuIHRoZSBwYW5lbCByZWYgZm9yIG9ud2FyZCBhc3NpZ25tZW50LlxuICAgKi9cbiAgYXBwbHkoZm46IChjb21wb25lbnQ6IFQpID0+IHZvaWQpOiBTb2hvQ29udGV4dHVhbEFjdGlvblBhbmVsUmVmPFQ+IHtcbiAgICBpZiAoZm4gJiYgdGhpcy5jb21wb25lbnRSZWY/Lmluc3RhbmNlKSB7XG4gICAgICBmbih0aGlzLmNvbXBvbmVudFJlZj8uaW5zdGFuY2UpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBwYW5lbCByZXN1bHQgcHJvcGVydHkuXG4gICAqXG4gICAqIEBwYXJhbSBwYW5lbFJlc3VsdCAtIHRoZSBzdG9yZWQgcmVzdWx0IG9mIHRoZSBwYW5lbC5cbiAgICovXG4gIHNldCBwYW5lbFJlc3VsdChwYW5lbFJlc3VsdDogYW55KSB7XG4gICAgdGhpcy5fcGFuZWxSZXN1bHQgPSBwYW5lbFJlc3VsdDtcbiAgfVxuICBnZXQgcGFuZWxSZXN1bHQoKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5fcGFuZWxSZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogQ29uc3RydWN0b3IuXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsXG4gICAgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgICBzZXR0aW5nczogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbE9wdGlvbnMsXG4gICAgcGFuZWxDb21wb25lbnQ/OiBQYW5lbENvbXBvbmVudFR5cGU8VD4pIHtcblxuICAgIGlmIChzZXR0aW5ncykge1xuICAgICAgdGhpcy5vcHRpb25zKHNldHRpbmdzKTtcbiAgICB9XG5cbiAgICBpZiAocGFuZWxDb21wb25lbnQpIHtcbiAgICAgIHRoaXMuY29tcG9uZW50UmVmID0gY29tcG9uZW50RmFjdG9yeVJlc29sdmVyXG4gICAgICAgIC5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShwYW5lbENvbXBvbmVudClcbiAgICAgICAgLmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcblxuICAgICAgYXBwUmVmLmF0dGFjaFZpZXcodGhpcy5jb21wb25lbnRSZWYuaG9zdFZpZXcpO1xuICAgICAgdGhpcy5fb3B0aW9ucy5jb250ZW50ID0galF1ZXJ5KHRoaXMuY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB0aGUgcGFuZWwuXG4gICAqXG4gICAqIEByZXR1cm4gdGhlIHBhbmVsIHJlZi5cbiAgICovXG4gIG9wZW4oKTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB7XG4gICAgaWYgKHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsKSB7XG4gICAgICAvLyB0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbC5vcGVuKCk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuY29tcG9uZW50UmVmICYmICF0aGlzLl9vcHRpb25zLmNvbnRlbnQpIHtcbiAgICAgIHRocm93IEVycm9yKCdjb21wb25lbnRSZWYgb3IgY29udGVudCBtdXN0IGJlIGluaXRpYWxpc2VkLicpO1xuICAgIH1cblxuICAgIHRoaXMualF1ZXJ5RWxlbWVudCA9IHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIGNvbnN0IGVsZW1lbnQgPSBqUXVlcnkoJ2JvZHknKTtcbiAgICAgIGVsZW1lbnQuY29udGV4dHVhbGFjdGlvbnBhbmVsKHRoaXMuX29wdGlvbnMpO1xuXG4gICAgICB0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbCA9IGVsZW1lbnQuZGF0YSgnY29udGV4dHVhbGFjdGlvbnBhbmVsJyk7XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0dWFsYWN0aW9ucGFuZWw/LmVsZW1lbnQ7XG4gICAgfSk7XG5cbiAgICAvLyBBZGQgbGlzdGVuZXJzIHRvIGNvbnRyb2wgZXZlbnRzXG4gICAgdGhpcy5qUXVlcnlFbGVtZW50Py5vbignY2xvc2UuY29udGV4dHVhbGFjdGlvbnBhbmVsJywgKChldmVudDogYW55LCBpc0NhbmNlbGxlZDogYm9vbGVhbikgPT4ge1xuICAgICAgdGhpcy5vbkNsb3NlKGV2ZW50LCBpc0NhbmNlbGxlZCk7XG4gICAgfSkpO1xuICAgIHRoaXMualF1ZXJ5RWxlbWVudD8ub24oJ29wZW4uY29udGV4dHVhbGFjdGlvbnBhbmVsJywgKChldmVudDogYW55KSA9PiB7XG4gICAgICB0aGlzLm9uT3BlbihldmVudCk7XG4gICAgfSkpO1xuICAgICh0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbCBhcyBhbnkpLnBhbmVsPy5vbignYWZ0ZXJjbG9zZS5jb250ZXh0dWFsYWN0aW9ucGFuZWwnLCAoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgIHRoaXMub25BZnRlckNsb3NlKGV2ZW50KTtcbiAgICB9KSk7XG4gICAgKHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsIGFzIGFueSkucGFuZWw/Lm9uKCdhZnRlcm9wZW4uY29udGV4dHVhbGFjdGlvbnBhbmVsJywgKChldmVudDogYW55KSA9PiB7XG4gICAgICB0aGlzLm9uQWZ0ZXJPcGVuKGV2ZW50KTtcbiAgICB9KSk7XG4gICAgKHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsIGFzIGFueSkucGFuZWw/Lm9uKCdiZWZvcmVjbG9zZS5jb250ZXh0dWFsYWN0aW9ucGFuZWwnLCAoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgIHRoaXMub25CZWZvcmVDbG9zZShldmVudCk7XG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogQ2xvc2VzIHRoZSBwYW5lbCwgaWYgb3Blbi4gVGhlIHBhbmVsIGlzIG5vdCBjbG9zZWRcbiAgICogZnVsbHkgdW50aWwgdGhlICdhZnRlckNsb3NlZCcgZXZlbnQgaXMgZmlyZWQuXG4gICAqXG4gICAqIEBwYXJhbSBwYW5lbFJlc3VsdCAtIG9wdGlvbmFsIHJlc3VsdCAtIHBhc3NlZCBiYWNrIHRvIHRoZSBjYWxsZXIuXG4gICAqIEBwYXJhbSBkb0ZvcmNlIC0gb3B0aW9uYWwgLSBmb3JjZXMgdGhlIG1vZGFsIHRvIGNsb3NlLlxuICAgKi9cbiAgY2xvc2UocGFuZWxSZXN1bHQ/OiBhbnksIGRvRm9yY2U/OiBib29sZWFuKTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB7XG4gICAgdGhpcy5wYW5lbFJlc3VsdCA9IHBhbmVsUmVzdWx0O1xuICAgIGlmICh0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbCkge1xuICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICB0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbD8uY2xvc2UoZG9Gb3JjZSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gRXZlbnRzXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gIC8qKlxuICAgKiBPcGVuZWQgRXZlbnQuXG4gICAqXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiB0aGUgcGFuZWwgaXMgYmVpbmcgb3BlbmVkLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnRGbiAtIHRoZSBmdW5jdGlvbiB0byBpbnZva2Ugd2hlbiB0aGUgcGFuZWwgaXMgdG8gYmUgb3BlbmVkLlxuICAgKi9cbiAgb3BlbmVkKGV2ZW50Rm46IEZ1bmN0aW9uKTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB8IG51bGwge1xuICAgIHRoaXMub3BlbiQucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQkKSkuc3Vic2NyaWJlKChmOiBhbnkpID0+IHtcbiAgICAgIGV2ZW50Rm4oZiwgdGhpcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogT3BlbmVkIEV2ZW50LlxuICAgKiBUaGlzIGV2ZW50IGlzIGZpcmVkIGFmdGVyIHRoZSBwYW5lbCBoYXMgYmVlbiBvcGVuZWQuXG4gICAqXG4gICAqIEBwYXJhbSBldmVudEZuIC0gdGhlIGZ1bmN0aW9uIHRvIGludm9rZSB3aGVuIHRoZSBwYW5lbCBpcyB0byBiZSBvcGVuZWQuXG4gICAqL1xuICBhZnRlck9wZW4oZXZlbnRGbjogRnVuY3Rpb24pOiBTb2hvQ29udGV4dHVhbEFjdGlvblBhbmVsUmVmPFQ+IHwgbnVsbCB7XG4gICAgdGhpcy5hZnRlck9wZW4kLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCkpLnN1YnNjcmliZSgoZjogYW55KSA9PiB7XG4gICAgICBldmVudEZuKGYsIHRoaXMpO1xuICAgIH0pO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIEJlZm9yZSBDbG9zZWQgRXZlbnQuXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgYmVmb3JlIGNsb3NpbmcgdGhlIHBhbmVsLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnRGbiAtIHRoZSBmdW5jdGlvbiB0byBpbnZva2Ugd2hlbiB0aGUgcGFuZWwgYmVmb3JlIGNsb3NpbmcuXG4gICAqL1xuICBiZWZvcmVDbG9zZShldmVudEZuOiBGdW5jdGlvbik6IFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxSZWY8VD4gfCBudWxsIHtcbiAgICB0aGlzLmJlZm9yZUNsb3NlJC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCQpKS5zdWJzY3JpYmUoKGY6IGFueSkgPT4ge1xuICAgICAgZXZlbnRGbihmLCB0aGlzKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBDbG9zZWQgRXZlbnQuXG4gICAqXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiB0aGUgcGFuZWwgaXMgYmVpbmcgY2xvc2VkLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnRGbiAtIHRoZSBmdW5jdGlvbiB0byBpbnZva2Ugd2hlbiB0aGUgcGFuZWwgaXMgdG8gYmUgY2xvc2VkLlxuICAgKi9cbiAgY2xvc2VkKGV2ZW50Rm46IFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxFdmVudEZ1bmN0aW9uPFQ+KTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB8IG51bGwge1xuICAgIHRoaXMuY2xvc2UkLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCkpLnN1YnNjcmliZSgocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgIGV2ZW50Rm4ocmVzdWx0LCB0aGlzLCAodGhpcy5jb21wb25lbnRQYW5lbCBhcyBhbnkpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBBZnRlciBDbG9zZWQgRXZlbnQuXG4gICAqXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQsIHdpdGggdGhlIHJlc3VsdCBvZiB0aGUgcGFuZWwsIHdoZW4gdGhlIHBhbmVsIGhhcyBiZWVuXG4gICAqIGNsb3NlZCBhbmQgZGVzdHJveWVkLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnRGbiAtIHRoZSBmdW5jdGlvbiB0byBpbnZva2UgYWZ0ZXIgdGhlIHBhbmVsIGhhcyBiZWVuIGNsb3NlZC5cbiAgICovXG4gIGFmdGVyQ2xvc2UoZXZlbnRGbjogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbEV2ZW50RnVuY3Rpb248VD4gfCBudWxsKTogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiB8IG51bGwge1xuICAgIHRoaXMuYWZ0ZXJDbG9zZSQucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQkKSkuc3Vic2NyaWJlKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgaWYgKCFldmVudEZuKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGV2ZW50Rm4ocmVzdWx0LCB0aGlzLCAodGhpcy5jb21wb25lbnRQYW5lbCBhcyBhbnkpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gRXZlbnQgSGFuZGxlcnNcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gIC8qKlxuICAgKiBIYW5kbGVzIHRoZSAnb3BlbicgZXZlbnQsIGZpcmVkIGp1c3QgYmVmb3JlXG4gICAqIHRoZSBmb2N1cyBpcyBhc3NpZ25lZCB0byBhIHBhbmVsLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnQgLSBmdWxsIGV2ZW50IG9iamVjdC5cbiAgICovXG4gIHByaXZhdGUgb25PcGVuKGV2ZW50OiBhbnkpIHtcbiAgICB0aGlzLm9wZW4kLm5leHQoZXZlbnQpO1xuICB9XG4gIC8qKlxuICAgKiBIYW5kbGVzIHRoZSAnYWZ0ZXJPcGVuJyBldmVudCwgZmlyZWQgYWZ0ZXIgdGhlIHBhbmVsIHBhbmVsXG4gICAqIGhhcyBiZWVuIG9wZW5lZC5cbiAgICpcbiAgICogQHBhcmFtIGV2ZW50IC0gZnVsbCBldmVudCBvYmplY3QuXG4gICAqL1xuICBwcml2YXRlIG9uQWZ0ZXJPcGVuKGV2ZW50OiBhbnkpIHtcbiAgICB0aGlzLmFmdGVyT3BlbiQubmV4dChldmVudCk7XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlcyB0aGUgY2xvc2UgZXZlbnQuXG4gICAqXG4gICAqIEBwYXJhbSBldmVudCAtIGZ1bGwgZXZlbnQgb2JqZWN0LlxuICAgKiBAcGFyYW0gaXNDYW5jZWxsZWQgLSBpcyB0cnVlIGlmIHRoZSBjYW5jZWwgYnV0dG9uIHdhcyBwcmVzc2VkOyBvdGhlcndpc2UgZmFsc2UuXG4gICAqL1xuICBwcml2YXRlIG9uQ2xvc2UoX2V2ZW50OiBhbnksIGlzQ2FuY2VsbGVkOiBib29sZWFuKSB7XG4gICAgdGhpcy5jbG9zZSQubmV4dChpc0NhbmNlbGxlZCk7XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlcyB0aGUgJ2FmdGVyQ2xvc2UnIGV2ZW50LCBmaXJlZCB3aGVuIHRoIHBhbmVsXG4gICAqIGhhcyBiZWVuIGNsb3NlZCBhbmQgdGlkeSB1cCBpcyByZXF1aXJlZC5cbiAgICpcbiAgICogQHBhcmFtIGV2ZW50IC0gZnVsbCBldmVudCBvYmplY3QuXG4gICAqL1xuICBwcml2YXRlIG9uQWZ0ZXJDbG9zZShfZXZlbnQ6IGFueSkge1xuICAgIC8vIFBhc3MgdGhlIHBhbmVsIHJlc3VsdCBiYWNrLlxuICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICB0aGlzLmFmdGVyQ2xvc2UkLm5leHQodGhpcy5wYW5lbFJlc3VsdCk7XG4gICAgICB0aGlzLmFmdGVyQ2xvc2UkLmNvbXBsZXRlKCk7XG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5qUXVlcnlFbGVtZW50KSB7XG4gICAgICB0aGlzLmpRdWVyeUVsZW1lbnQub2ZmKCdjbG9zZS5jb250ZXh0dWFsYWN0aW9ucGFuZWwgb3Blbi5jb250ZXh0dWFsYWN0aW9ucGFuZWwnKTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbnRleHR1YWxhY3Rpb25wYW5lbD8uZGVzdHJveSgpO1xuICAgIHRoaXMuY29udGV4dHVhbGFjdGlvbnBhbmVsID0gbnVsbDtcblxuICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICBpZiAodGhpcy5jb21wb25lbnRSZWYpIHtcbiAgICAgICAgdGhpcy5hcHBSZWYuZGV0YWNoVmlldyh0aGlzLmNvbXBvbmVudFJlZi5ob3N0Vmlldyk7XG4gICAgICAgIHRoaXMuY29tcG9uZW50UmVmLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5jb21wb25lbnRSZWYgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmRlc3Ryb3llZCQubmV4dChfZXZlbnQpO1xuICAgICAgdGhpcy5kZXN0cm95ZWQkLmNvbXBsZXRlKCk7XG4gICAgfSk7XG5cbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGVzIHRoZSAnYmVmb3JlY2xvc2UnIGV2ZW50LlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnQgLSBmdWxsIGV2ZW50IG9iamVjdC5cbiAgICovXG4gIHByaXZhdGUgb25CZWZvcmVDbG9zZShldmVudDogYW55KSB7XG4gICAgdGhpcy5iZWZvcmVDbG9zZSQubmV4dChldmVudCk7XG4gIH1cbn1cbi8qKlxuICogQ2xvc2UvQWZ0ZXJDbG9zZSBldmVudCBoYW5kbGVyLlxuICpcbiAqIEBwYXJhbSByZXN1bHQgLSB0aGUgcGFuZWwgcmVzdWx0IChpZiBzZXQpOyBtYXkgYmUgdW5kZWZpbmVkLlxuICogQHBhcmFtIHBhbmVsUmVmIC0gdGhlIHBhbmVsIHJlZmVyZW5jZSAob3Igd3JhcHBlcik7IG5ldmVyIG51bGwuXG4gKiBAcGFyYW0gcGFuZWxDb21wb25lbnQgLSB0aGUgY29tcG9uZW50IGhvc3RlZCBpbiB0aGUgbW9kYWw7IG1heSBiZSB1bmRlZmluZWQuXG4gKi9cbmV4cG9ydCB0eXBlIFNvaG9Db250ZXh0dWFsQWN0aW9uUGFuZWxFdmVudEZ1bmN0aW9uPFQ+ID0gKHJlc3VsdDogYW55LCBwYW5lbFJlZjogU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbFJlZjxUPiwgcGFuZWxDb21wb25lbnQ6IFQpID0+IHZvaWQ7XG5cbi8qKlxuICogQ29udHJhY3QgZm9yIGFsbCBTb2hvQ29udGV4dHVhbEFjdGlvblBhbmVsQ29tcG9uZW50cy5cbiAqL1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1pbnRlcmZhY2VcbmV4cG9ydCBpbnRlcmZhY2UgU29ob0NvbnRleHR1YWxBY3Rpb25QYW5lbENvbXBvbmVudDxUPiB7XG59XG4iXX0=